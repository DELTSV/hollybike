-- liquibase formatted sql

-- changeset denis:1
CREATE TABLE IF NOT EXISTS "associations"
(
    "id_association" INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    "name"           VARCHAR(255)                             NOT NULL,
    "status"         INTEGER DEFAULT 1                        NOT NULL,
    CONSTRAINT "associations_pk" PRIMARY KEY ("id_association")
);

CREATE TABLE IF NOT EXISTS "users"
(
    "id_user"     INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    "email"       VARCHAR                                  NOT NULL,
    "username"    VARCHAR                                  NOT NULL,
    "password"    VARCHAR                                  NOT NULL,
    "status"      INTEGER DEFAULT 1                        NOT NULL,
    "scope"       INTEGER DEFAULT 1                        NOT NULL,
    "association" INTEGER                                  NOT NULL,
    "last_login"  TIMESTAMP WITHOUT TIME ZONE              NOT NULL,
    CONSTRAINT "users_pk" PRIMARY KEY ("id_user")
);
CREATE UNIQUE INDEX IF NOT EXISTS "associations_name_uindex" ON "associations" ("name");
CREATE UNIQUE INDEX IF NOT EXISTS "users_email_uindex" ON "users" ("email");
ALTER TABLE "users"
    ADD CONSTRAINT "users_associations_id_association_fk" FOREIGN KEY ("association") REFERENCES "associations" ("id_association") ON UPDATE NO ACTION ON DELETE NO ACTION;

-- changeset denis:2 context:dev
INSERT INTO associations (name)
VALUES ('Motoloup');

-- changeset denis:3
ALTER TABLE users
    ADD COLUMN IF NOT EXISTS profile_picture VARCHAR(2048) DEFAULT null;
ALTER TABLE associations
    ADD COLUMN IF NOT EXISTS picture VARCHAR(2048) DEFAULT null;

-- changeset loic:1
CREATE TABLE IF NOT EXISTS events
(
    id_event         INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL
        CONSTRAINT events_pk
            PRIMARY KEY,
    name             VARCHAR(1000)                            NOT NULL,
    description      VARCHAR(1000),
    association      INTEGER                                  NOT NULL
        CONSTRAINT events_association_fk
            REFERENCES associations,
    image            VARCHAR(2048),
    status           INTEGER   DEFAULT 1                      NOT NULL,
    owner            INTEGER                                  NOT NULL
        CONSTRAINT events_owner_fk
            REFERENCES users ON DELETE CASCADE,
    start_date_time  TIMESTAMP                                NOT NULL,
    end_date_time    TIMESTAMP,
    create_date_time TIMESTAMP DEFAULT NOW()                  NOT NULL,
    update_date_time TIMESTAMP DEFAULT NOW()                  NOT NULL
);

-- changeset loic:2

CREATE TABLE IF NOT EXISTS users_participate_events
(
    id_participation INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL
        CONSTRAINT users_participate_events_pk
            PRIMARY KEY,
    "user"           INTEGER                                  NOT NULL
        CONSTRAINT users_participate_events_user_fk
            REFERENCES users ON DELETE CASCADE,
    event            INTEGER                                  NOT NULL
        CONSTRAINT users_participate_events_event_fk
            REFERENCES events ON DELETE CASCADE,
    role             INTEGER                                  NOT NULL DEFAULT 1,
    joined_date_time TIMESTAMP                                NOT NULL DEFAULT NOW() NOT NULL,
    CONSTRAINT users_participate_events_unique_key
        UNIQUE ("user", event)
);

-- changeset denis:4
CREATE TABLE IF NOT EXISTS invitations
(
    id_invitation INTEGER GENERATED BY DEFAULT AS IDENTITY         NOT NULL PRIMARY KEY,
    role          INTEGER                                          NOT NULL,
    status        INTEGER                                                   DEFAULT 1 NOT NULL,
    association   INTEGER REFERENCES associations (id_association) NOT NULL,
    creator       INTEGER REFERENCES users (id_user)               NOT NULL,
    expiration    TIMESTAMP,
    creation      TIMESTAMP                                        NOT NULL DEFAULT NOW(),
    uses          INTEGER                                          NOT NULL DEFAULT 0,
    max_uses      INTEGER                                                   DEFAULT NULL
);

-- changeset loic:3 context:test
INSERT INTO associations (name)
VALUES ('Root Association');
INSERT INTO associations (name)
VALUES ('Association 1');
INSERT INTO associations (name)
VALUES ('Association 2');
INSERT INTO associations (name, status)
VALUES ('Disabled Association', -1);

INSERT INTO users (email, username, password, association, last_login, scope)
VALUES ('root@hollybike.fr', 'root', 'JDJhJDA2JHJwVWE4dWdyUi9URERJdWt4cll0VU9yLmRQSExWdTUzdlB4bWFQbktZanppZVd2V01vdFpX',
        1, now(), 3);

INSERT INTO users (email, username, password, association, last_login, scope)
VALUES ('user1@hollybike.fr', 'user1',
        'JDJhJDA2JHJwVWE4dWdyUi9URERJdWt4cll0VU9yLmRQSExWdTUzdlB4bWFQbktZanppZVd2V01vdFpX', 2, now(), 1);
INSERT INTO users (email, username, password, association, last_login, scope)
VALUES ('user2@hollybike.fr', 'user2',
        'JDJhJDA2JHJwVWE4dWdyUi9URERJdWt4cll0VU9yLmRQSExWdTUzdlB4bWFQbktZanppZVd2V01vdFpX', 2, now(), 1);
INSERT INTO users (email, username, password, association, last_login, scope)
VALUES ('user3@hollybike.fr', 'user3',
        'JDJhJDA2JHJwVWE4dWdyUi9URERJdWt4cll0VU9yLmRQSExWdTUzdlB4bWFQbktZanppZVd2V01vdFpX', 3, now(), 1);
INSERT INTO users (email, username, password, association, last_login, scope)
VALUES ('user4@hollybike.fr', 'user4',
        'JDJhJDA2JHJwVWE4dWdyUi9URERJdWt4cll0VU9yLmRQSExWdTUzdlB4bWFQbktZanppZVd2V01vdFpX', 3, now(), 1);
INSERT INTO users (email, username, password, association, last_login, scope)
VALUES ('user5@hollybike.fr', 'user5',
        'JDJhJDA2JHJwVWE4dWdyUi9URERJdWt4cll0VU9yLmRQSExWdTUzdlB4bWFQbktZanppZVd2V01vdFpX', 3, now(), 1);
INSERT INTO users (email, username, password, association, last_login, scope)
VALUES ('user6@hollybike.fr', 'user6',
        'JDJhJDA2JHJwVWE4dWdyUi9URERJdWt4cll0VU9yLmRQSExWdTUzdlB4bWFQbktZanppZVd2V01vdFpX', 4, now(), 1);


INSERT INTO users (email, username, password, association, last_login, scope, status)
VALUES ('disabled1@hollybike.fr', 'disabled1',
        'JDJhJDA2JHJwVWE4dWdyUi9URERJdWt4cll0VU9yLmRQSExWdTUzdlB4bWFQbktZanppZVd2V01vdFpX', 2, now(), 1, -1);
INSERT INTO users (email, username, password, association, last_login, scope, status)
VALUES ('disabled2@hollybike.fr', 'disabled2',
        'JDJhJDA2JHJwVWE4dWdyUi9URERJdWt4cll0VU9yLmRQSExWdTUzdlB4bWFQbktZanppZVd2V01vdFpX', 3, now(), 1, -1);
INSERT INTO users (email, username, password, association, last_login, scope, status)
VALUES ('disabled3@hollybike.fr', 'disabled3',
        'JDJhJDA2JHJwVWE4dWdyUi9URERJdWt4cll0VU9yLmRQSExWdTUzdlB4bWFQbktZanppZVd2V01vdFpX', 4, now(), 1, -1);


INSERT INTO users (email, username, password, association, last_login, scope)
VALUES ('admin1@hollybike.fr', 'admin1',
        'JDJhJDA2JHJwVWE4dWdyUi9URERJdWt4cll0VU9yLmRQSExWdTUzdlB4bWFQbktZanppZVd2V01vdFpX', 2, now(), 2);
INSERT INTO users (email, username, password, association, last_login, scope)
VALUES ('admin2@hollybike.fr', 'admin2',
        'JDJhJDA2JHJwVWE4dWdyUi9URERJdWt4cll0VU9yLmRQSExWdTUzdlB4bWFQbktZanppZVd2V01vdFpX', 3, now(), 2);
INSERT INTO users (email, username, password, association, last_login, scope)
VALUES ('admin3@hollybike.fr', 'admin3',
        'JDJhJDA2JHJwVWE4dWdyUi9URERJdWt4cll0VU9yLmRQSExWdTUzdlB4bWFQbktZanppZVd2V01vdFpX', 4, now(), 2);

INSERT INTO events (name, description, association, image, status, owner, start_date_time, end_date_time)
VALUES ('Event 1 - Asso 1', 'Description 1', 2, null, 1, 2, now() + interval '1' day, now() + interval '2' day);
INSERT INTO users_participate_events ("user", event, role)
VALUES (2, 1, 2);

INSERT INTO events (name, description, association, image, status, owner, start_date_time, end_date_time)
VALUES ('Event 2 - Asso 1', 'Description 2', 2, null, 2, 2, now() - interval '1' day, now() + interval '1' day);
INSERT INTO users_participate_events ("user", event, role)
VALUES (2, 2, 2);
INSERT INTO users_participate_events ("user", event, role)
VALUES (3, 2, 1);

INSERT INTO events (name, description, association, image, status, owner, start_date_time, end_date_time)
VALUES ('Event 3 - Asso 1', 'Description 3', 2, null, 3, 2, now() + interval '1' day, now() + interval '2' day);
INSERT INTO users_participate_events ("user", event, role)
VALUES (2, 3, 2);

INSERT INTO events (name, description, association, image, status, owner, start_date_time, end_date_time)
VALUES ('Event 4 - Asso 1', 'Description 4', 2, null, 4, 2, now() - interval '2' day, now() - interval '1' day);
INSERT INTO users_participate_events ("user", event, role)
VALUES (2, 4, 2);

INSERT INTO events (name, description, association, image, status, owner, start_date_time, end_date_time)
VALUES ('Event 5 - Asso 1', 'Description 5', 2, null, 2, 3, now() - interval '1' day, null);
INSERT INTO users_participate_events ("user", event, role)
VALUES (3, 5, 2);

INSERT INTO events (name, description, association, image, status, owner, start_date_time, end_date_time)
VALUES ('Event 6 - Asso 1', 'Description 6', 2, null, 2, 3, now() + interval '1' day, now() + interval '2' day);
INSERT INTO users_participate_events ("user", event, role)
VALUES (3, 6, 2);

INSERT INTO events (name, description, association, image, status, owner, start_date_time, end_date_time)
VALUES ('Event 1 - Asso 2', 'Description 1', 3, null, 2, 4, now() + interval '1' day, now() + interval '2' day);
INSERT INTO users_participate_events ("user", event, role)
VALUES (4, 7, 2);
INSERT INTO users_participate_events ("user", event, role)
VALUES (5, 7, 2);

INSERT INTO events (name, description, association, image, status, owner, start_date_time, end_date_time)
VALUES ('Event 2 - Asso 2', 'Description 2', 3, null, 1, 5, now() + interval '1' day, now() + interval '2' day);
INSERT INTO users_participate_events ("user", event, role)
VALUES (5, 8, 2);

INSERT INTO events (name, description, association, image, status, owner, start_date_time, end_date_time)
VALUES ('Event 3 - Asso 2', 'Description 3', 3, null, 2, 5, now() + interval '1' day, now() + interval '2' day);
INSERT INTO users_participate_events ("user", event, role)
VALUES (5, 9, 2);

INSERT INTO events (name, description, association, image, status, owner, start_date_time, end_date_time)
VALUES ('Event 4 - Asso 2', 'Description 4', 3, null, 2, 5, now() + interval '1' day, now() + interval '2' day);
INSERT INTO users_participate_events ("user", event, role)
VALUES (5, 10, 2);
INSERT INTO users_participate_events ("user", event, role)
VALUES (4, 10, 1);
INSERT INTO users_participate_events ("user", event, role)
VALUES (6, 10, 1);

INSERT INTO events (name, description, association, image, status, owner, start_date_time, end_date_time)
VALUES ('Event 5 - Asso 2', 'Description 5', 3, null, 2, 5, now() + interval '1' day, now() + interval '2' day);
INSERT INTO users_participate_events ("user", event, role)
VALUES (5, 11, 2);
INSERT INTO users_participate_events ("user", event, role)
VALUES (4, 11, 2);
INSERT INTO users_participate_events ("user", event, role)
VALUES (6, 11, 1);


-- changeset denis:5
CREATE EXTENSION IF NOT EXISTS unaccent;

-- changeset denis:6
ALTER TABLE associations
    ADD COLUMN IF NOT EXISTS update_default_user BOOLEAN DEFAULT false,
    ADD COLUMN IF NOT EXISTS update_association BOOLEAN DEFAULT false,
    ADD COLUMN IF NOT EXISTS create_invitation BOOLEAN DEFAULT false;


-- changeset denis:7 context:"!test and premise"
INSERT INTO associations (name) VALUES ('Hollybike');
INSERT INTO users (email, username, password, association, last_login, scope) VALUES ('admin@hollybike.fr', 'Admin', 'JDJhJDA2JEtHaDN5c0pIc1guU2s5V3g2Ulpjek95YXAvZVpkQllPNjlPMUFHTFhuV1pua2RyZnpzVDdh
', LASTVAL(), NOW(), 2);

-- changeset loic:4

CREATE TABLE IF NOT EXISTS event_images
(
    id_event_image   INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL
        CONSTRAINT event_images_pk
            PRIMARY KEY,
    owner            INTEGER                                  NOT NULL
        CONSTRAINT event_images_owner_fk
            REFERENCES users ON DELETE CASCADE,
    event            INTEGER                                  NOT NULL
        CONSTRAINT event_images_event_fk
            REFERENCES events ON DELETE CASCADE,
    path             VARCHAR(2048)                            NOT NULL,
    size             INTEGER                                  NOT NULL,
    upload_date_time TIMESTAMP DEFAULT NOW()                  NOT NULL
);

-- changeset loic:5

ALTER TABLE users_participate_events
    ADD COLUMN IF NOT EXISTS is_images_public BOOLEAN DEFAULT TRUE NOT NULL;

ALTER TABLE users_participate_events
    ADD COLUMN IF NOT EXISTS is_joined BOOLEAN DEFAULT TRUE NOT NULL;

ALTER TABLE users_participate_events
    ADD COLUMN IF NOT EXISTS left_date_time TIMESTAMP DEFAULT NULL;

ALTER TABLE users_participate_events
    RENAME TO event_participations;

-- changeset loic:6

ALTER TABLE event_images
    ADD COLUMN IF NOT EXISTS taken_date_time TIMESTAMP;

ALTER TABLE event_images
    ADD COLUMN IF NOT EXISTS latitude DOUBLE PRECISION;

ALTER TABLE event_images
    ADD COLUMN IF NOT EXISTS longitude DOUBLE PRECISION;

ALTER TABLE event_images
    ADD COLUMN IF NOT EXISTS altitude DOUBLE PRECISION;